<!DOCTYPE html>
<html>
<head>
  <title>Robot Controller</title>
  <script src="./lib/socket.io-1.2.0.js"></script>
  <script src="./robot.js"></script>
  <script src="./keyboard.js"></script>
  <style>
  body {
    font-family: Arial, Helvetica, sans-serif;
  }
  button {
    width: 60px;
  }
  #controls {
    padding: 5px;
  }
  #distance {
    font-size: 12pt;
    padding: 5px;
  }
  #distanceVal {
    color: green;
    float: left;
    font-size: 60pt;
    width: 100px;
    padding-left: 20px;
  }
  #distanceEq {
    padding-top: 5px;
    float: left;
    width: 100px;
    height: 80px;
  }
  #eqTable {
    width: 100%;
    height: 100%;
  }
  td {
    background-color: white;
    border: 2px solid green;
  }
  </style>
</head>
<body>
  <div id="controls">
    <button onclick="robot_stop()">Stop</button>
    <button onclick="robot_forward()">Forward</button>
    <button onclick="robot_backward()">Back</button>
    <button onclick="robot_right()">Right</button>
    <button onclick="robot_left()">Left</button>
    <button onclick="robot_ledOn()">Led On</button>
    <button onclick="robot_ledOff()">Led Off</button>
    <button onclick="robot_ping()">Ping</button>
    <button onclick="robot_reset()">Reset</button>
    <button onclick="toggle_sound()">Sound</button>
  </div>

  <div id="distance">
    <div>Distance (CM)</div>
    <div id="distanceEq">
      <table id="eqTable">
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
      </table>
    </div>
    <div id="distanceVal"></div>
  </div>

<script>

var colors = ['red','orange','green','green','green'];

var distanceValEl = document.getElementById('distanceVal');
var eqCells = document.querySelectorAll('table#eqTable td');

var AUDIO_VOLUME = 0.02;
var REFRESH_DELAY = 1000;

var audio_vol = AUDIO_VOLUME;

var ctx = new (window.AudioContext || window.webkitAudioContext)();
var o = ctx.createOscillator();
o.type = 'square';

var g = ctx.createGain();
g.gain.value = 0;
o.connect(g);
g.connect(ctx.destination);
o.start(0);

document.addEventListener('visibilitychange', function(){
    if (document.hidden) {
      audio_vol = 0;
    }
    else {
      audio_vol = AUDIO_VOLUME;
    }
},false);

var audioOn = true;
function toggle_sound() {
  if(audioOn)
    audioOn = false;
  else
    audioOn = true;
}

document.addEventListener('keydown', keyDownHandler, false);

setInterval(function() {
  var distance = robot_get_distance();
  distanceValEl.textContent = distance;
  var step = Math.floor(distance / 20);
  if(step > 4)
    step = 4;
  setColor(step);
  if(distance > 1 && audioOn)
    beep(step);
}, REFRESH_DELAY);

function setColor(step) {
  var color = colors[step];
  distanceValEl.style.color = color;
  eqCells.forEach(function(cell, index) {
    cell.style.borderColor = color;
    if(index == step)
      cell.style.backgroundColor = color
    else
      cell.style.backgroundColor = 'white';
  });
}

function beep(step) {
  o.frequency.value = ((5 - step) * (5 - step) * 100);
  g.gain.value = audio_vol * (5 - step);
  setTimeout(function(){ g.gain.value = 0; }, 100);
}

processHash();

window.onhashchange = function() {
  processHash();
};

function processHash() {
  switchMode(window.location.hash.substring(1));
}

function switchMode(mode) {
  if(mode == 'sim')
    loadJS("./postmessage-robot.js");
  else if(mode == 'test')
    loadJS("./test-robot.js");
  else if(mode == 'robot')
    loadJS("./websocket-robot.js");
  console.log("Mode: " + mode);
}

function loadJS(file) {
  var script = document.createElement("script");
  script.type = "application/javascript";
  script.src = file;
  document.body.appendChild(script);
}

</script>
</body>
</html>
